#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.2
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   டम��, currentLine, currentValue
  printf "%s" "${1}" | tr -d '[:space:]'
}

# parse distributance from .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) MVNW_REPOURL="${MVNW_REPOURL:-$(trim "${value-}")}" ;;
  distributionSha256Sum) MVNW_SHA256="${MVNW_SHA256:-$(trim "${value-}")}" ;;
  wrapperUrl) MVNW_WRAPPERURL="${MVNW_WRAPPERURL:-$(trim "${value-}")}" ;;
  wrapperSha256Sum) MVNW_WRAPPERSHA256="${MVNW_WRAPPERSHA256:-$(trim "${value-}")}" ;;
  esac
done <"${0%/*}/.mvn/wrapper/maven-wrapper.properties"

# apply defaults
[ -n "${MVNW_REPOURL-}" ] || MVNW_REPOURL="https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.6/apache-maven-3.9.6-bin.zip"

# normalize URL
case "${MVNW_REPOURL-}" in
*/) MVNW_REPOURL="${MVNW_REPOURL%/}" ;;
esac

MAVEN_HOME="${MAVEN_HOME:-${HOME}/.m2/wrapper/dists/$(hash_string "$MVNW_REPOURL")}"
MAVEN_ZIP="${MAVEN_HOME}/maven.zip"
MAVEN_BIN="${MAVEN_HOME}/bin/mvn"

set_java_home || die "Please set JAVA_HOME or ensure java and javac are in PATH."

if [ ! -x "$MAVEN_BIN" ]; then
  mkdir -p "$MAVEN_HOME"
  verbose "Downloading Maven from $MVNW_REPOURL"

  if command -v wget >/dev/null; then
    wget -O "$MAVEN_ZIP" "$MVNW_REPOURL" || die "Failed to download Maven"
  elif command -v curl >/dev/null; then
    curl -fsSL -o "$MAVEN_ZIP" "$MVNW_REPOURL" || die "Failed to download Maven"
  else
    die "Neither wget nor curl found; cannot download Maven"
  fi

  # verify SHA256 if provided
  if [ -n "${MVNW_SHA256-}" ]; then
    verbose "Verifying Maven ZIP SHA256"
    if command -v sha256sum >/dev/null; then
      echo "$MVNW_SHA256  $MAVEN_ZIP" | sha256sum -c - || die "SHA256 mismatch"
    elif command -v shasum >/dev/null; then
      echo "$MVNW_SHA256  $MAVEN_ZIP" | shasum -a 256 -c - || die "SHA256 mismatch"
    fi
  fi

  # extract maven
  verbose "Extracting Maven"
  unzip -q "$MAVEN_ZIP" -d "$MAVEN_HOME" || die "Failed to extract Maven"

  # move extracted dir to expected location
  mv "$MAVEN_HOME"/apache-maven-*/* "$MAVEN_HOME/" 2>/dev/null || :
  rm -rf "$MAVEN_HOME"/apache-maven-* "$MAVEN_ZIP"

  chmod +x "$MAVEN_BIN"
fi

exec "$MAVEN_BIN" "$@"
